{% extends 'base.html' %} {% block body %}

<div class="conteudo-classico">
  <h1>Modo Clássico</h1>

  {% if resultado %}
  <p
    class="resultado-mensagem {% if 'Acertou' in resultado %}acertou{% elif 'Errou' in resultado %}errou{% elif 'não encontrado' in resultado %}time-nao-encontrado{% endif %}"
  >
    {{ resultado }}
  </p>
  {% endif %}

  <form method="post" id="form-chute">
    <label for="chute">Digite um time:</label>
    <div class="autocomplete-container">
      <input
        type="text"
        id="chute"
        name="chute"
        required
        placeholder="Ex: Flamengo, Santos, Palmeiras..."
        autocomplete="off"
      />
      <div class="sugestoes-lista" id="sugestoes-lista"></div>
    </div>
    <button type="submit">Enviar</button>
  </form>

  <script>
    let sugestaoSelecionada = -1;
    let sugestoes = [];
    let timeoutId;

    function setupAutoComplete() {
      const input = document.getElementById("chute");
      const sugestoesLista = document.getElementById("sugestoes-lista");

      input.addEventListener("input", function () {
        const query = this.value.trim();

        clearTimeout(timeoutId);

        if (query.length < 1) {
          sugestoesLista.style.display = "none";
          return;
        }

        timeoutId = setTimeout(() => {
          fetch(`/api/sugestoes?q=${encodeURIComponent(query)}`)
            .then((response) => response.json())
            .then((data) => {
              sugestoes = data;
              sugestaoSelecionada = -1;
              mostrarSugestoes(data);
            })
            .catch((error) => {
              console.error("Erro ao buscar sugestões:", error);
              sugestoesLista.style.display = "none";
            });
        }, 200);
      });

      input.addEventListener("keydown", function (event) {
        const sugestoesLista = document.getElementById("sugestoes-lista");

        if (sugestoesLista.style.display === "none") return;

        if (event.key === "ArrowDown") {
          event.preventDefault();
          sugestaoSelecionada = Math.min(
            sugestaoSelecionada + 1,
            sugestoes.length - 1
          );
          atualizarSelecao();
        } else if (event.key === "ArrowUp") {
          event.preventDefault();
          sugestaoSelecionada = Math.max(sugestaoSelecionada - 1, -1);
          atualizarSelecao();
        } else if (event.key === "Enter") {
          if (sugestaoSelecionada >= 0) {
            event.preventDefault();
            selecionarSugestao(sugestoes[sugestaoSelecionada]);
          } else if (sugestoes.length > 0 && sugestoesLista.style.display !== "none") {
            // Se há sugestões disponíveis mas nenhuma selecionada, usar a primeira
            event.preventDefault();
            selecionarSugestao(sugestoes[0]);
          }
          // Se não há sugestões, deixa o Enter normal do form funcionar
        } else if (event.key === "Escape") {
          sugestoesLista.style.display = "none";
          sugestaoSelecionada = -1;
        }
      });

      document.addEventListener("click", function (event) {
        if (!event.target.closest(".autocomplete-container")) {
          sugestoesLista.style.display = "none";
          sugestaoSelecionada = -1;
        }
      });
    }

    function mostrarSugestoes(sugestoes) {
      const sugestoesLista = document.getElementById("sugestoes-lista");

      if (sugestoes.length === 0) {
        sugestoesLista.style.display = "none";
        return;
      }

      sugestoesLista.innerHTML = "";

      sugestoes.forEach((sugestao, index) => {
        const item = document.createElement("div");
        item.className = "sugestao-item";
        item.innerHTML = `
          <img src="/static/times/${sugestao.escudo}" alt="${sugestao.nome}" class="sugestao-escudo" onerror="this.style.display='none'">
          <span class="sugestao-nome">${sugestao.nome}</span>
        `;

        item.addEventListener("click", () => selecionarSugestao(sugestao));
        item.addEventListener("mouseenter", () => {
          sugestaoSelecionada = index;
          atualizarSelecao();
        });

        sugestoesLista.appendChild(item);
      });

      sugestoesLista.style.display = "block";
    }

    function atualizarSelecao() {
      const items = document.querySelectorAll(".sugestao-item");
      items.forEach((item, index) => {
        item.classList.toggle("selected", index === sugestaoSelecionada);
      });
    }

    function selecionarSugestao(sugestao) {
      const input = document.getElementById("chute");
      const sugestoesLista = document.getElementById("sugestoes-lista");
      
      input.value = sugestao.nome;
      sugestoesLista.style.display = "none";
      sugestaoSelecionada = -1;
      
      // Enviar o formulário automaticamente
      document.getElementById("form-chute").dispatchEvent(new Event('submit'));
    }    document
      .getElementById("form-chute")
      .addEventListener("submit", function (event) {
        event.preventDefault();

        const formData = new FormData(this);
        const chute = formData.get("chute");

        fetch(window.location.href, {
          method: "POST",
          body: formData,
        })
          .then((response) => response.text())
          .then((html) => {
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = html;

            const novoConteudo = tempDiv.querySelector(".conteudo-classico");
            if (novoConteudo) {
              document.querySelector(".conteudo-classico").innerHTML =
                novoConteudo.innerHTML;

              const input = document.getElementById("chute");
              if (input) {
                input.value = "";
                input.focus();
              }

              // Reconfigurar o autocomplete após recarregar o conteúdo
              setupAutoComplete();

              document
                .getElementById("form-chute")
                .addEventListener("submit", arguments.callee);
            }
          })
          .catch((error) => {
            console.error("Erro:", error);
            this.submit();
          });
      });

    // Configurar o autocomplete quando a página carrega
    setupAutoComplete();
  </script>

  {% if tentativas %}
  <div
    class="tentativas-container"
    style="
      display: flex;
      flex-direction: column-reverse;
      gap: 10px;
      margin-top: 20px;
      flex-wrap: wrap;
    "
  >
    {% for time in tentativas %}
    <div
      class="tentativa-item"
      style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px"
    >
      <img
        src="{{ url_for('static', filename='times/' ~ time.nome_arquivo() ~ '.jpg') }}"
        alt="{{ time.nome }}"
        style="
          width: 100px;
          height: 100px;
          object-fit: cover;
          border-radius: 8px;
          border: 2px solid #444;
        "
      />

      <div
        style="
          background-color: {% set resultado_cor = comparar_cores(time.cores, time_secreto.cores) %}{% if resultado_cor == 'exato' %}#28a745{% elif resultado_cor == 'parcial' %}#ffc107{% else %}#dc3545{% endif %};
          padding: 15px;
          border-radius: 8px;
          color: {% if comparar_cores(time.cores, time_secreto.cores) == 'parcial' %}black{% else %}white{% endif %};
          text-align: center;
          min-width: 120px;
          border: 2px solid #ddd;
        "
      >
        <strong>{{ time.cores }}</strong>
      </div>

      <div
        style="
          background-color: {% if time.estado == time_secreto.estado %}#28a745{% else %}#dc3545{% endif %};
          padding: 15px;
          border-radius: 8px;
          color: white;
          text-align: center;
          min-width: 80px;
          border: 2px solid #ddd;
        "
      >
        <strong>{{ time.estado }}</strong>
      </div>

      <div
        style="
          background-color: {% if time.ano_fundacao == time_secreto.ano_fundacao %}#28a745{% else %}#dc3545{% endif %};
          padding: 15px;
          border-radius: 8px;
          color: white;
          text-align: center;
          min-width: 80px;
          border: 2px solid #ddd;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 5px;
        "
      >
        <strong>{{ time.ano_fundacao }}</strong>
        {% set resultado_ano = comparar_anos(time.ano_fundacao,
        time_secreto.ano_fundacao) %} {% if resultado_ano == 'seta_cima' %}
        <span style="font-size: 16px">↑</span>
        {% elif resultado_ano == 'seta_baixo' %}
        <span style="font-size: 16px">↓</span>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}
</div>

{% endblock %}
