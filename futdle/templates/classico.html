{% extends 'base.html' %} {% block body %}

<div
  class="conteudo-classico {% if jogo_finalizado %}jogo-finalizado{% endif %}"
>
  <div class="titulo-container">
    <h1>Modo Cl√°ssico</h1>
    <button class="botao-ajuda" onclick="mostrarAjuda()" title="Como jogar">
      ?
    </button>
  </div>

  {% if resultado %}
  <p
    class="resultado-mensagem {% if 'Acertou' in resultado %}acertou{% elif 'Errou' in resultado %}errou{% elif 'n√£o encontrado' in resultado %}time-nao-encontrado{% endif %}"
  >
    {{ resultado }}
  </p>
  {% endif %} {% if jogo_finalizado %}
  <button class="botao-jogar-novamente" onclick="jogarNovamente()">
    Jogar Novamente
  </button>
  {% else %}
  <div class="secao-dicas">
    {% if tentativas_erradas >= 1 %}
    <div class="dicas-disponiveis">
      <!-- Dica da S√©rie -->
      <div class="dica-container">
        {% if tentativas_erradas >= 4 and time_secreto.serie %}
        <h3>DICA DISPON√çVEL!</h3>
        <div class="dica-serie">
          <p class="texto-dica-inicio">Este time est√° na...</p>
          <button class="botao-revelar-dica" onclick="revelarDica('serie')">
            Clique para ver
          </button>
          <p
            class="texto-dica-oculto"
            id="serie-revelado"
            style="display: none"
          >
            <strong>S√©rie {{ time_secreto.serie }}</strong>!
          </p>
        </div>
        {% else %}
        <h3>DICA BLOQUEADA</h3>
        <div class="dica-bloqueada-individual">
          <p class="texto-dica-inicio">Este time est√° na...</p>
          <p class="texto-dica-bloqueada">Dispon√≠vel aos 4 erros</p>
        </div>
        {% endif %}
      </div>

      <!-- Dica do Mascote -->
      <div class="dica-container">
        {% if tentativas_erradas >= 7 and time_secreto.mascote %}
        <h3>DICA DISPON√çVEL!</h3>
        <div class="dica-mascote">
          <p class="texto-dica-inicio">O mascote desse time √© o/a...</p>
          <button class="botao-revelar-dica" onclick="revelarDica('mascote')">
            Clique para ver
          </button>
          <p
            class="texto-dica-oculto"
            id="mascote-revelado"
            style="display: none"
          >
            <strong>{{ time_secreto.mascote }}</strong>!
          </p>
        </div>
        {% else %}
        <h3>DICA BLOQUEADA</h3>
        <div class="dica-bloqueada-individual">
          <p class="texto-dica-inicio">O mascote desse time √© o/a...</p>
          <p class="texto-dica-bloqueada">Dispon√≠vel aos 7 erros</p>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Contador de tentativas -->
    <div class="contador-tentativas">
      <span class="label-contador">Tentativas Erradas:</span>
      <span class="numero-tentativas">{{ tentativas_erradas }}</span>
    </div>
    {% endif %}
  </div>
  {% endif %}

  <div class="formulario-chute">
    <form method="post" id="form-chute">
      <label for="chute">Digite um time:</label>
      <div class="autocomplete-container">
        <input
          type="text"
          id="chute"
          name="chute"
          required
          placeholder="Ex: Flamengo, Santos, Palmeiras..."
          autocomplete="off"
        />
        <div class="sugestoes-lista" id="sugestoes-lista"></div>
      </div>
      <button type="submit">Enviar</button>
    </form>
  </div>

  {% if tentativas %}
  <div class="cabecalho-tentativas">
    <div class="col-nome">NOME</div>
    <div class="col-cores">CORES</div>
    <div class="col-estado">ESTADO</div>
    <div class="col-ano">ANO DE FUNDA√á√ÉO</div>
  </div>
  {% endif %} {% if tentativas %}
  <div class="tentativas-container">
    {% for time in tentativas %}
    <div class="tentativa-item">
      <div class="escudo-simples">
        <div class="nome-clube">{{ time.nome }}</div>
        <img
          src="{{ url_for('static', filename='times/' ~ time.nome_arquivo() ~ '.jpg') }}"
          alt="{{ time.nome }}"
        />
      </div>

      <div
        class="cores-simples"
        style="background-color: {% set resultado_cor = comparar_cores(time.cores, time_secreto.cores) %}{% if resultado_cor == 'exato' %}#28a745{% elif resultado_cor == 'parcial' %}#ffc107{% else %}#dc3545{% endif %}; color: {% if comparar_cores(time.cores, time_secreto.cores) == 'parcial' %}black{% else %}white{% endif %};"
      >
        <strong>{{ time.cores }}</strong>
      </div>

      <div
        class="estado-simples"
        style="background-color: {% if time.estado == time_secreto.estado %}#28a745{% else %}#dc3545{% endif %};"
      >
        <strong>{{ time.estado }}</strong>
      </div>

      <div
        class="ano-simples"
        style="background-color: {% if time.ano_fundacao == time_secreto.ano_fundacao %}#28a745{% else %}#dc3545{% endif %};"
      >
        <strong>{{ time.ano_fundacao }}</strong>
        {% set diferenca_anos = (time.ano_fundacao - time_secreto.ano_fundacao) %}
        {% if diferenca_anos > 0 %}<span>‚Üì</span>
        {% elif diferenca_anos < 0 %}<span>‚Üë</span>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <script>
    class FutdleGame {
      constructor() {
        this.sugestaoSelecionada = -1;
        this.sugestoes = [];
        this.timeoutId = null;
        this.init();
      }

      init() {
        this.setupAutoComplete();
        this.setupFormSubmit();
      }

      setupAutoComplete() {
        const input = document.getElementById("chute");
        const sugestoesLista = document.getElementById("sugestoes-lista");

        if (!input || !sugestoesLista) return;

        input.addEventListener("input", (e) => this.handleInput(e));
        input.addEventListener("keydown", (e) => this.handleKeydown(e));
        document.addEventListener("click", (e) => this.handleClickOutside(e));
      }

      handleInput(event) {
        const query = event.target.value.trim();
        clearTimeout(this.timeoutId);

        if (query.length < 1) {
          document.getElementById("sugestoes-lista").style.display = "none";
          return;
        }

        this.timeoutId = setTimeout(() => {
          fetch(`/api/sugestoes?q=${encodeURIComponent(query)}`)
            .then((response) => response.json())
            .then((data) => {
              this.sugestoes = data;
              this.sugestaoSelecionada = -1;
              this.mostrarSugestoes(data);
            })
            .catch((error) => {
              console.error("Erro ao buscar sugest√µes:", error);
              document.getElementById("sugestoes-lista").style.display = "none";
            });
        }, 200);
      }

      handleKeydown(event) {
        const sugestoesLista = document.getElementById("sugestoes-lista");
        if (sugestoesLista.style.display === "none") return;

        switch (event.key) {
          case "ArrowDown":
            event.preventDefault();
            this.sugestaoSelecionada = Math.min(
              this.sugestaoSelecionada + 1,
              this.sugestoes.length - 1
            );
            this.atualizarSelecao();
            break;
          case "ArrowUp":
            event.preventDefault();
            this.sugestaoSelecionada = Math.max(
              this.sugestaoSelecionada - 1,
              -1
            );
            this.atualizarSelecao();
            break;
          case "Enter":
            if (this.sugestaoSelecionada >= 0) {
              event.preventDefault();
              this.selecionarSugestao(this.sugestoes[this.sugestaoSelecionada]);
            } else if (
              this.sugestoes.length > 0 &&
              sugestoesLista.style.display !== "none"
            ) {
              event.preventDefault();
              this.selecionarSugestao(this.sugestoes[0]);
            }
            break;
          case "Escape":
            sugestoesLista.style.display = "none";
            this.sugestaoSelecionada = -1;
            break;
        }
      }

      handleClickOutside(event) {
        if (!event.target.closest(".autocomplete-container")) {
          document.getElementById("sugestoes-lista").style.display = "none";
          this.sugestaoSelecionada = -1;
        }
      }

      mostrarSugestoes(sugestoes) {
        const sugestoesLista = document.getElementById("sugestoes-lista");

        if (sugestoes.length === 0) {
          sugestoesLista.style.display = "none";
          return;
        }

        sugestoesLista.innerHTML = sugestoes
          .map(
            (sugestao, index) =>
              `<div class="sugestao-item" data-index="${index}">
          <img src="/static/times/${sugestao.escudo}" alt="${sugestao.nome}" class="sugestao-escudo" onerror="this.style.display='none'">
          <span class="sugestao-nome">${sugestao.nome}</span>
        </div>`
          )
          .join("");

        sugestoesLista
          .querySelectorAll(".sugestao-item")
          .forEach((item, index) => {
            item.addEventListener("click", () =>
              this.selecionarSugestao(sugestoes[index])
            );
            item.addEventListener("mouseenter", () => {
              this.sugestaoSelecionada = index;
              this.atualizarSelecao();
            });
          });

        sugestoesLista.style.display = "block";
      }

      atualizarSelecao() {
        document.querySelectorAll(".sugestao-item").forEach((item, index) => {
          item.classList.toggle("selected", index === this.sugestaoSelecionada);
        });
      }

      selecionarSugestao(sugestao) {
        const input = document.getElementById("chute");
        input.value = sugestao.nome;
        document.getElementById("sugestoes-lista").style.display = "none";
        this.sugestaoSelecionada = -1;
        document
          .getElementById("form-chute")
          .dispatchEvent(new Event("submit"));
      }

      setupFormSubmit() {
        const form = document.getElementById("form-chute");
        if (!form) return;

        form.addEventListener("submit", (event) => {
          event.preventDefault();

          fetch(window.location.href, {
            method: "POST",
            body: new FormData(form),
          })
            .then((response) => response.text())
            .then((html) => {
              const tempDiv = document.createElement("div");
              tempDiv.innerHTML = html;
              const novoConteudo = tempDiv.querySelector(".conteudo-classico");

              if (novoConteudo) {
                const jogoFinalizado =
                  novoConteudo.classList.contains("jogo-finalizado");

                // Verifica se h√° mensagem de "Acertou!" no resultado
                const resultadoMensagem = tempDiv.querySelector(
                  ".resultado-mensagem"
                );
                const acertou =
                  resultadoMensagem &&
                  resultadoMensagem.textContent.includes("Acertou");

                if (jogoFinalizado || acertou) {
                  // Refresh imediato ap√≥s acerto
                  window.location.reload();
                } else {
                  // Salva o estado das dicas reveladas antes de atualizar
                  const dicasReveladas = {
                    serie:
                      document.getElementById("serie-revelado") &&
                      document.getElementById("serie-revelado").style
                        .display !== "none",
                    mascote:
                      document.getElementById("mascote-revelado") &&
                      document.getElementById("mascote-revelado").style
                        .display !== "none",
                  };

                  document.querySelector(".conteudo-classico").innerHTML =
                    novoConteudo.innerHTML;

                  // Restaura o estado das dicas reveladas
                  if (dicasReveladas.serie) {
                    const botaoSerie = document.querySelector(
                      ".dica-serie .botao-revelar-dica"
                    );
                    const serieRevelado =
                      document.getElementById("serie-revelado");
                    if (botaoSerie && serieRevelado) {
                      botaoSerie.style.display = "none";
                      serieRevelado.style.display = "block";
                    }
                  }

                  if (dicasReveladas.mascote) {
                    const botaoMascote = document.querySelector(
                      ".dica-mascote .botao-revelar-dica"
                    );
                    const mascoteRevelado =
                      document.getElementById("mascote-revelado");
                    if (botaoMascote && mascoteRevelado) {
                      botaoMascote.style.display = "none";
                      mascoteRevelado.style.display = "block";
                    }
                  }

                  const input = document.getElementById("chute");
                  if (input) {
                    input.value = "";
                    input.focus();
                  }
                  new FutdleGame();
                }
              }
            })
            .catch((error) => {
              console.error("Erro:", error);
              form.submit();
            });
        });
      }
    }

    function jogarNovamente() {
      fetch("/reiniciar-jogo", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) window.location.reload();
        })
        .catch((error) => {
          console.error("Erro ao reiniciar jogo:", error);
          window.location.reload();
        });
    }

    function revelarDica(tipo) {
      let botaoRevelar, elementoRevelado;

      if (tipo === "mascote") {
        botaoRevelar = document.querySelector(
          ".dica-mascote .botao-revelar-dica"
        );
        elementoRevelado = document.getElementById("mascote-revelado");
      } else if (tipo === "serie") {
        botaoRevelar = document.querySelector(
          ".dica-serie .botao-revelar-dica"
        );
        elementoRevelado = document.getElementById("serie-revelado");
      }

      if (botaoRevelar && elementoRevelado) {
        botaoRevelar.style.display = "none";
        elementoRevelado.style.display = "block";
        elementoRevelado.style.animation = "fadeIn 0.5s ease-in";
      }
    }

    function mostrarAjuda() {
      document.getElementById("modal-ajuda").style.display = "flex";
    }

    function fecharAjuda() {
      document.getElementById("modal-ajuda").style.display = "none";
    }

    document.addEventListener("DOMContentLoaded", () => new FutdleGame());
  </script>
</div>

<!-- Modal de Ajuda -->
<div id="modal-ajuda" class="modal-ajuda">
  <div class="modal-conteudo">
    <div class="modal-header">
      <h2>Como Jogar - Modo Cl√°ssico</h2>
      <span class="botao-fechar" onclick="fecharAjuda()">&times;</span>
    </div>
    <div class="modal-body">
      <div class="ajuda-secao">
        <h3>üéØ Objetivo</h3>
        <p>Descubra qual √© o time de futebol brasileiro secreto!</p>
      </div>

      <div class="ajuda-secao">
        <h3>‚öΩ Como Jogar</h3>
        <ul>
          <li>Digite o nome de um time brasileiro</li>
          <li>Receba dicas baseadas nas caracter√≠sticas do time</li>
          <li>Use as cores das dicas para se aproximar da resposta</li>
        </ul>
      </div>

      <div class="ajuda-secao">
        <h3>üé® C√≥digo de Cores</h3>
        <div class="cores-exemplo">
          <div class="cor-exemplo verde">
            <span class="cor-box"></span>
            <span>Verde = Correto</span>
          </div>
          <div class="cor-exemplo amarelo">
            <span class="cor-box"></span>
            <span>Amarelo = Parcialmente correto</span>
          </div>
          <div class="cor-exemplo vermelho">
            <span class="cor-box"></span>
            <span>Vermelho = Incorreto</span>
          </div>
        </div>
      </div>

      <div class="ajuda-secao">
        <h3>üí° Dicas Especiais</h3>
        <ul>
          <li>
            <strong>4 tentativas erradas:</strong> Voc√™ recebe uma dica sobre a
            s√©rie do time (A, B, C ou D)
          </li>
          <li>
            <strong>7 tentativas erradas:</strong> Voc√™ recebe uma dica sobre o
            mascote do time
          </li>
        </ul>
      </div>

      <div class="assinatura-copilot">
        <p>
          <small>üí° Este modal foi criado com aux√≠lio do GitHub Copilot</small>
        </p>
      </div>
    </div>
  </div>
</div>

{% endblock %}
