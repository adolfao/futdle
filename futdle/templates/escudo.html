{% extends 'base.html' %} {% block body %}

<div
  class="conteudo-classico {% if jogo_finalizado %}jogo-finalizado{% endif %}"
>
  <!-- t√≠tulo -->
  <div class="titulo-container">
    <h1 class="modo-classico-titulo text-center">
      <i class="bi bi-shield-check"></i> Modo Escudo
    </h1>
  </div>

  <!-- escudo secreto -->
  <div class="escudo-secreto-container text-center">
    <div class="escudo-time-secreto mx-auto">
      <img
        id="escudo-imagem"
        src="{{ url_for('static', filename='times_escudo/' ~ time_secreto_nome ~ '_escudo.png') }}"
        alt="Escudo do time secreto"
        class="img-fluid zoom-nivel-{{ tentativas_erradas or 0 }}"
        onerror="this.src='{{ url_for('static', filename='images/bola.png') }}'"
      />
    </div>

    <!-- Bot√£o para alternar cores -->
    <button
      id="botao-cores"
      class="botao-alternar-cores"
      onclick="alternarCores()"
      {%
      if
      jogo_finalizado
      %}disabled{%
      endif
      %}
    >
      <i class="bi bi-palette"></i>
      <span id="texto-botao-cores">Mostrar Cores</span>
    </button>

    <!-- Bot√£o para alternar rota√ß√£o -->
    <button
      id="botao-rotacao"
      class="botao-alternar-rotacao"
      onclick="alternarRotacao()"
      {%
      if
      jogo_finalizado
      %}disabled{%
      endif
      %}
    >
      <i class="bi bi-arrow-clockwise"></i>
      <span id="texto-botao-rotacao">Rota√ß√£o Normal</span>
    </button>
  </div>

  <div class="formulario-chute">
    <form method="post" id="form-chute">
      <label for="chute">Digite um time:</label>
      <div class="autocomplete-container">
        <input
          type="text"
          id="chute"
          name="chute"
          required
          placeholder="Exemplo: Flamengo"
          autocomplete="off"
          {%
          if
          jogo_finalizado
          %}disabled{%
          endif
          %}
        />
        <button type="submit" {% if jogo_finalizado %}disabled{% endif %}>
          Enviar
        </button>
        <div class="sugestoes-lista" id="sugestoes-lista"></div>
      </div>
    </form>

    <!-- Contador de tentativas -->
    <div class="contador-tentativas mt-3">
      <span class="label-contador">Tentativas Erradas:</span>
      <span class="numero-tentativas" id="contador-erradas"
        >{{ tentativas_erradas or 0 }}</span
      >
    </div>

    <!-- Container para mensagens de resultado -->
    <div
      class="resultado-container-abaixo"
      id="resultado-container-abaixo"
      style="display: none"
    >
      <div class="d-flex align-items-center gap-3">
        <p
          class="resultado-mensagem-abaixo mb-0"
          id="resultado-mensagem-dinamico"
        ></p>
        <button
          class="btn btn-success btn-sm botao-tentar-novamente-inline"
          onclick="jogarNovamente()"
          id="botao-tentar-novamente"
          style="display: none"
        >
          <i class="bi bi-arrow-clockwise me-1"></i>
          Tentar Novamente
        </button>
      </div>
    </div>
  </div>

  <!-- Tentativas feitas -->
  {% if tentativas %}
  <div class="tentativas-container-escudo">
    <h3>Times que voc√™ tentou:</h3>
    <div class="lista-tentativas-escudo">
      {% for tentativa in tentativas %}
      <div class="tentativa-item-escudo">
        <div class="tentativa-escudo">
          <img
            src="{{ url_for('static', filename='times/') }}{{ tentativa.escudo }}"
            alt="{{ tentativa.nome }}"
            onerror="this.src='{{ url_for('static', filename='images/bola.png') }}'"
          />
        </div>
        <div class="tentativa-nome">{{ tentativa.nome }}</div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <script>
    class FutdleEscudoGame {
      constructor() {
        this.sugestaoSelecionada = -1;
        this.sugestoes = [];
        this.timeoutId = null;
        this.init();
      }

      init() {
        this.setupAutoComplete();
        this.setupFormSubmit();

        // Inicializa o zoom baseado nas tentativas erradas atuais
        const tentativasErradas = {{ tentativas_erradas or 0 }};
        this.aplicarZoomAleatorio();
        this.aplicarRotacaoAleatoria();
        this.atualizarZoom(tentativasErradas);

        // Inicializa estado das cores (sempre come√ßa em P&B)
        this.coresAtivadas = false;
        this.rotacaoNormal = false;

        // Torna a imagem vis√≠vel ap√≥s configurar tudo
        const imagem = document.getElementById("escudo-imagem");
        if (imagem) {
          imagem.classList.add("js-loaded");
        }
      }

      setupAutoComplete() {
        const input = document.getElementById("chute");
        const sugestoesLista = document.getElementById("sugestoes-lista");

        if (!input || !sugestoesLista) return;

        input.addEventListener("input", (e) => this.handleInput(e));
        input.addEventListener("keydown", (e) => this.handleKeydown(e));
        document.addEventListener("click", (e) => this.handleClickOutside(e));
      }

      handleInput(event) {
        const query = event.target.value.trim();
        clearTimeout(this.timeoutId);

        if (query.length < 1) {
          document.getElementById("sugestoes-lista").style.display = "none";
          return;
        }

        this.timeoutId = setTimeout(() => {
          fetch(
            `{{ url_for('main.sugestoes_escudo') }}?q=${encodeURIComponent(
              query
            )}`
          )
            .then((response) => response.json())
            .then((data) => {
              this.sugestoes = data;
              this.sugestaoSelecionada = -1;
              this.mostrarSugestoes(data);
            })
            .catch((error) => {
              console.error("Erro ao buscar sugest√µes:", error);
              document.getElementById("sugestoes-lista").style.display = "none";
            });
        }, 200);
      }

      handleKeydown(event) {
        const sugestoesLista = document.getElementById("sugestoes-lista");
        if (sugestoesLista.style.display === "none") return;

        switch (event.key) {
          case "ArrowDown":
            event.preventDefault();
            this.sugestaoSelecionada = Math.min(
              this.sugestaoSelecionada + 1,
              this.sugestoes.length - 1
            );
            this.atualizarSelecao();
            break;
          case "ArrowUp":
            event.preventDefault();
            this.sugestaoSelecionada = Math.max(
              this.sugestaoSelecionada - 1,
              -1
            );
            this.atualizarSelecao();
            break;
          case "Enter":
            if (this.sugestaoSelecionada >= 0) {
              event.preventDefault();
              this.selecionarSugestao(this.sugestoes[this.sugestaoSelecionada]);
            } else if (
              this.sugestoes.length > 0 &&
              sugestoesLista.style.display !== "none"
            ) {
              event.preventDefault();
              this.selecionarSugestao(this.sugestoes[0]);
            }
            break;
          case "Escape":
            sugestoesLista.style.display = "none";
            this.sugestaoSelecionada = -1;
            break;
        }
      }

      handleClickOutside(event) {
        if (!event.target.closest(".autocomplete-container")) {
          document.getElementById("sugestoes-lista").style.display = "none";
          this.sugestaoSelecionada = -1;
        }
      }

      mostrarSugestoes(sugestoes) {
        const sugestoesLista = document.getElementById("sugestoes-lista");

        if (sugestoes.length === 0) {
          sugestoesLista.style.display = "none";
          return;
        }

        sugestoesLista.innerHTML = sugestoes
          .map(
            (sugestao, index) =>
              `<div class="sugestao-item" data-index="${index}">
          <img src="{{ url_for('static', filename='times/') }}${sugestao.escudo}" alt="${sugestao.nome}" class="sugestao-escudo" onerror="this.style.display='none'">
          <span class="sugestao-nome">${sugestao.nome}</span>
        </div>`
          )
          .join("");

        // Adiciona indicador de quantidade se h√° muitos resultados
        if (sugestoes.length > 5) {
          const indicator = document.createElement("div");
          indicator.className = "sugestoes-indicator";
          indicator.innerHTML = `<small>üìä ${sugestoes.length} times encontrados</small>`;
          sugestoesLista.insertBefore(indicator, sugestoesLista.firstChild);
        }

        sugestoesLista
          .querySelectorAll(".sugestao-item")
          .forEach((item, index) => {
            item.addEventListener("click", () =>
              this.selecionarSugestao(sugestoes[index])
            );
            item.addEventListener("mouseenter", () => {
              this.sugestaoSelecionada = index;
              this.atualizarSelecao();
            });
          });

        sugestoesLista.style.display = "block";
      }

      atualizarSelecao() {
        document.querySelectorAll(".sugestao-item").forEach((item, index) => {
          item.classList.toggle("selected", index === this.sugestaoSelecionada);
        });
      }

      selecionarSugestao(sugestao) {
        const input = document.getElementById("chute");
        input.value = sugestao.nome;
        document.getElementById("sugestoes-lista").style.display = "none";
        this.sugestaoSelecionada = -1;
        this.enviarChute();
      }

      setupFormSubmit() {
        const form = document.getElementById("form-chute");
        if (!form) return;

        form.addEventListener("submit", (event) => {
          event.preventDefault();
          this.enviarChute();
        });
      }

      async enviarChute() {
        const form = document.getElementById("form-chute");
        const input = document.getElementById("chute");

        if (!input.value.trim()) return;

        try {
          const response = await fetch("/escudo", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: `chute=${encodeURIComponent(input.value)}`,
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          console.log("Resposta do servidor:", data);

          if (data.sucesso) {
            this.mostrarMensagem("üéâ Parab√©ns! Voc√™ acertou!", "acertou");
            this.desabilitarFormulario();
          } else {
            this.atualizarContador(data.tentativas_erradas || 0);
            if (data.time_chutado) {
              this.adicionarTentativa(data.time_chutado);
            }

            // Determina a classe baseada no tipo de erro
            let classe = "errou";
            let mensagem = data.mensagem || "Tente novamente!";

            if (
              mensagem.includes("n√£o foi encontrado") ||
              mensagem.includes("n√£o encontrado")
            ) {
              classe = "time-nao-encontrado";
            } else if (
              mensagem.includes("j√° foi tentado") ||
              mensagem.includes("j√° digitado")
            ) {
              classe = "repetido"; // Usa classe espec√≠fica para times repetidos
            }

            this.mostrarMensagem(mensagem, classe);
          }
        } catch (error) {
          console.error("Erro completo:", error);
          this.mostrarMensagem(
            `Erro ao enviar chute: ${error.message}`,
            "time-nao-encontrado"
          );
        }

        input.value = "";
        input.focus();
      }

      atualizarContador(tentativasErradas) {
        const contador = document.getElementById("contador-erradas");
        if (contador) {
          contador.textContent = tentativasErradas;

          // Adiciona anima√ß√£o visual
          contador.style.transform = "scale(1.2)";
          contador.style.color = "#ff6b6b";

          setTimeout(() => {
            contador.style.transform = "scale(1)";
            contador.style.color = "#3ecf3e";
          }, 300);
        }

        // Atualiza o zoom da imagem baseado no n√∫mero de tentativas erradas
        this.atualizarZoom(tentativasErradas);
      }

      atualizarZoom(tentativasErradas) {
        const imagem = document.getElementById("escudo-imagem");
        if (imagem) {
          // Remove todas as classes de zoom existentes
          for (let i = 0; i <= 8; i++) {
            imagem.classList.remove(`zoom-nivel-${i}`);
          }

          // Aplica a classe correspondente ao n√∫mero de tentativas erradas (m√°ximo 8)
          const nivel = Math.min(tentativasErradas, 8);
          imagem.classList.add(`zoom-nivel-${nivel}`);

          // Atualiza o transform combinando zoom e rota√ß√£o
          this.atualizarTransform(nivel);

          console.log(`[DEBUG] Zoom atualizado para n√≠vel ${nivel} (${tentativasErradas} tentativas erradas)`);
        }
      }

      atualizarTransform(nivelZoom) {
        const imagem = document.getElementById("escudo-imagem");
        if (!imagem) return;

        // Define escalas para cada n√≠vel - corrigido para diminuir progressivamente
        const escalas = [5, 4.5, 4, 3.5, 3, 2.5, 2, 1.5, 1];
        const escala = escalas[Math.min(nivelZoom, 8)];

        // Pega a rota√ß√£o atual
        let rotacao = 0;
        const rotacoes = [
          'rotacao-15', 'rotacao-30', 'rotacao-45', 'rotacao-60', 'rotacao-90',
          'rotacao-120', 'rotacao-135', 'rotacao-150', 'rotacao-180', 'rotacao-210',
          'rotacao-225', 'rotacao-240', 'rotacao-270', 'rotacao-300', 'rotacao-315', 'rotacao-330'
        ];

        // Verifica qual rota√ß√£o est√° ativa
        for (let i = 0; i < rotacoes.length; i++) {
          if (imagem.classList.contains(rotacoes[i])) {
            rotacao = parseInt(rotacoes[i].replace('rotacao-', ''));
            break;
          }
        }

        if (imagem.classList.contains('rotacao-normal')) {
          rotacao = 0;
        }

        // Aplica transform combinado com centraliza√ß√£o
        imagem.style.transform = `translate(-50%, -50%) scale(${escala}) rotate(${rotacao}deg)`;

        console.log(`[DEBUG] Transform aplicado: translate(-50%, -50%) scale(${escala}) rotate(${rotacao}deg)`);
      }

      aplicarRotacaoAleatoria() {
        const imagem = document.getElementById("escudo-imagem");
        if (imagem) {
          // Define rota√ß√µes poss√≠veis
          const rotacoes = [
            'rotacao-15', 'rotacao-30', 'rotacao-45', 'rotacao-60', 'rotacao-90',
            'rotacao-120', 'rotacao-135', 'rotacao-150', 'rotacao-180', 'rotacao-210',
            'rotacao-225', 'rotacao-240', 'rotacao-270', 'rotacao-300', 'rotacao-315', 'rotacao-330'
          ];

          // Remove classes de rota√ß√£o anteriores
          rotacoes.forEach(classe => imagem.classList.remove(classe));
          imagem.classList.remove('rotacao-normal');

          // Escolhe uma rota√ß√£o aleat√≥ria
          const rotacaoAleatoria = rotacoes[Math.floor(Math.random() * rotacoes.length)];
          imagem.classList.add(rotacaoAleatoria);

          // Atualiza o transform com zoom atual
          const nivelZoom = {{ tentativas_erradas or 0 }};
          this.atualizarTransform(nivelZoom);

          console.log(`[DEBUG] Aplicada rota√ß√£o aleat√≥ria: ${rotacaoAleatoria}`);
        }
      }

      aplicarZoomAleatorio() {
        const imagem = document.getElementById("escudo-imagem");
        if (imagem) {
          // Define pontos de zoom poss√≠veis (evitando bordas transparentes)
          const pontosZoom = [
            'zoom-ponto-centro',
            'zoom-ponto-superior',
            'zoom-ponto-inferior',
            'zoom-ponto-esquerda',
            'zoom-ponto-direita',
            'zoom-ponto-superior-esquerda',
            'zoom-ponto-superior-direita',
            'zoom-ponto-inferior-esquerda',
            'zoom-ponto-inferior-direita'
          ];

          // Remove classes de zoom aleat√≥rio anteriores
          pontosZoom.forEach(classe => imagem.classList.remove(classe));

          // Escolhe um ponto aleat√≥rio
          const pontoAleatorio = pontosZoom[Math.floor(Math.random() * pontosZoom.length)];
          imagem.classList.add(pontoAleatorio);

          console.log(`[DEBUG] Aplicado zoom aleat√≥rio: ${pontoAleatorio}`);
        }
      }

      adicionarTentativa(timeChutado) {
        if (!timeChutado) return;

        let container = document.querySelector(".tentativas-container-escudo");

        // Cria o container se n√£o existir
        if (!container) {
          container = document.createElement("div");
          container.className = "tentativas-container-escudo";
          container.innerHTML = `
            <h3>Times que Voc√™ Tentou:</h3>
            <div class="lista-tentativas-escudo"></div>
          `;
          document.querySelector(".conteudo-classico").appendChild(container);
        }

        const lista = container.querySelector(".lista-tentativas-escudo");

        // Verifica se j√° existe para evitar duplicatas
        const jaExiste = Array.from(lista.children).some(
          (item) =>
            item.querySelector(".tentativa-nome").textContent ===
            timeChutado.nome
        );

        if (!jaExiste) {
          const tentativaItem = document.createElement("div");
          tentativaItem.className = "tentativa-item-escudo";
          tentativaItem.innerHTML = `
            <div class="tentativa-escudo">
              <img src="/static/times/${timeChutado.escudo}"
                   alt="${timeChutado.nome}"
                   onerror="this.src='/static/images/bola.png'">
            </div>
            <div class="tentativa-nome">${timeChutado.nome}</div>
          `;

          // Adiciona com anima√ß√£o
          tentativaItem.style.opacity = "0";
          tentativaItem.style.transform = "translateY(20px)";
          lista.appendChild(tentativaItem);

          setTimeout(() => {
            tentativaItem.style.transition =
              "opacity 0.3s ease, transform 0.3s ease";
            tentativaItem.style.opacity = "1";
            tentativaItem.style.transform = "translateY(0)";

            // Remove a transi√ß√£o inline ap√≥s a anima√ß√£o para n√£o interferir no hover
            setTimeout(() => {
              tentativaItem.style.transition = "";
            }, 300);
          }, 100);
        }
      }

      mostrarMensagem(mensagem, classe) {
        const resultadoContainer = document.getElementById(
          "resultado-container-abaixo"
        );
        const resultadoMensagem = document.getElementById(
          "resultado-mensagem-dinamico"
        );
        const botaoTentarNovamente = document.getElementById(
          "botao-tentar-novamente"
        );

        if (resultadoContainer && resultadoMensagem) {
          resultadoMensagem.textContent = mensagem;
          resultadoMensagem.className = `resultado-mensagem-abaixo mb-0 ${classe}`;
          resultadoContainer.style.display = "block";

          // Mostra bot√£o "Tentar Novamente" imediatamente quando acerta
          if (classe === "acertou" && botaoTentarNovamente) {
            botaoTentarNovamente.style.display = "inline-flex";
          } else if (botaoTentarNovamente) {
            // Esconde o bot√£o para outros tipos de mensagem
            botaoTentarNovamente.style.display = "none";
          }
        }
      }

      desabilitarFormulario() {
        const input = document.getElementById("time-input");
        const botao = document.getElementById("submit-btn");

        if (input) {
          input.disabled = true;
          input.style.opacity = "0.6";
          input.style.cursor = "not-allowed";
        }
        if (botao) {
          botao.disabled = true;
          botao.style.opacity = "0.6";
          botao.style.cursor = "not-allowed";
        }
      }

      mostrarBotaoJogarNovamente() {
        const botao = document.getElementById("botao-tentar-novamente");
        if (botao) {
          botao.style.display = "inline-flex";
        }
      }
    }

    document.addEventListener("DOMContentLoaded", () => new FutdleEscudoGame());

    // Fun√ß√£o global para alternar cores
    function alternarCores() {
      const imagem = document.getElementById("escudo-imagem");
      const botao = document.getElementById("botao-cores");
      const textoBotao = document.getElementById("texto-botao-cores");

      if (imagem && botao && textoBotao) {
        const jaColorido = imagem.classList.contains("colorido");

        if (jaColorido) {
          // Volta para P&B
          imagem.classList.remove("colorido");
          botao.classList.remove("colorido");
          textoBotao.textContent = "Mostrar Cores";
          botao.innerHTML = '<i class="bi bi-palette"></i><span id="texto-botao-cores">Mostrar Cores</span>';
        } else {
          // Ativa cores
          imagem.classList.add("colorido");
          botao.classList.add("colorido");
          textoBotao.textContent = "Preto e Branco";
          botao.innerHTML = '<i class="bi bi-palette-fill"></i><span id="texto-botao-cores">Preto e Branco</span>';
        }

        // Anima√ß√£o visual no bot√£o
        botao.style.transform = "scale(0.95)";
        setTimeout(() => {
          botao.style.transform = "scale(1)";
        }, 150);
      }
    }

    // Fun√ß√£o global para alternar rota√ß√£o
    function alternarRotacao() {
      const imagem = document.getElementById("escudo-imagem");
      const botao = document.getElementById("botao-rotacao");
      const textoBotao = document.getElementById("texto-botao-rotacao");

      if (imagem && botao && textoBotao) {
        const jaRotacaoNormal = imagem.classList.contains("rotacao-normal");

        // Define todas as classes de rota√ß√£o poss√≠veis
        const rotacoes = [
          'rotacao-15', 'rotacao-30', 'rotacao-45', 'rotacao-60', 'rotacao-90',
          'rotacao-120', 'rotacao-135', 'rotacao-150', 'rotacao-180', 'rotacao-210',
          'rotacao-225', 'rotacao-240', 'rotacao-270', 'rotacao-300', 'rotacao-315', 'rotacao-330'
        ];

        // Pega o n√≠vel de zoom atual
        let nivelZoom = 0;
        for (let i = 0; i <= 8; i++) {
          if (imagem.classList.contains(`zoom-nivel-${i}`)) {
            nivelZoom = i;
            break;
          }
        }

        if (jaRotacaoNormal) {
          // Volta para rota√ß√£o aleat√≥ria
          imagem.classList.remove("rotacao-normal");
          botao.classList.remove("normal");
          textoBotao.textContent = "Rota√ß√£o Normal";
          botao.innerHTML = '<i class="bi bi-arrow-clockwise"></i><span id="texto-botao-rotacao">Rota√ß√£o Normal</span>';

          // Aplica uma nova rota√ß√£o aleat√≥ria
          const rotacaoAleatoria = rotacoes[Math.floor(Math.random() * rotacoes.length)];
          imagem.classList.add(rotacaoAleatoria);
        } else {
          // Ativa rota√ß√£o normal (0 graus)
          rotacoes.forEach(classe => imagem.classList.remove(classe));
          imagem.classList.add("rotacao-normal");
          botao.classList.add("normal");
          textoBotao.textContent = "Rota√ß√£o Aleat√≥ria";
          botao.innerHTML = '<i class="bi bi-arrow-repeat"></i><span id="texto-botao-rotacao">Rota√ß√£o Aleat√≥ria</span>';
        }

        // Atualiza o transform
        const escalas = [5, 4.5, 4, 3.5, 3, 2.5, 2, 1.5, 1];
        const escala = escalas[Math.min(nivelZoom, 8)];

        let rotacao = 0;
        for (let i = 0; i < rotacoes.length; i++) {
          if (imagem.classList.contains(rotacoes[i])) {
            rotacao = parseInt(rotacoes[i].replace('rotacao-', ''));
            break;
          }
        }

        if (imagem.classList.contains('rotacao-normal')) {
          rotacao = 0;
        }

        imagem.style.transform = `translate(-50%, -50%) scale(${escala}) rotate(${rotacao}deg)`;

        // Anima√ß√£o visual no bot√£o
        botao.style.transform = "scale(0.95)";
        setTimeout(() => {
          botao.style.transform = "scale(1)";
        }, 150);
      }
    }

    // Fun√ß√£o global para o bot√£o "Tentar Novamente"
    function jogarNovamente() {
      // Reset das cores e rota√ß√£o antes do reload
      const imagem = document.getElementById("escudo-imagem");
      if (imagem) {
        imagem.classList.remove("colorido");
        imagem.classList.remove("rotacao-normal");

        // Remove todas as classes de rota√ß√£o
        const rotacoes = [
          'rotacao-15', 'rotacao-30', 'rotacao-45', 'rotacao-60', 'rotacao-90',
          'rotacao-120', 'rotacao-135', 'rotacao-150', 'rotacao-180', 'rotacao-210',
          'rotacao-225', 'rotacao-240', 'rotacao-270', 'rotacao-300', 'rotacao-315', 'rotacao-330'
        ];
        rotacoes.forEach(classe => imagem.classList.remove(classe));
      }

      // Op√ß√£o 1: Reset via API (mais limpo)
      fetch("/escudo/reset", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
      })
        .then(() => {
          window.location.reload();
        })
        .catch(() => {
          // Fallback: redirecionamento direto
          window.location.href = "/escudo";
        });
    }
  </script>
</div>

{% endblock %}
