{% extends 'base.html' %} {% block body %}

<div
  class="conteudo-classico {% if jogo_finalizado %}jogo-finalizado{% endif %}"
>
  <h1>Modo ClÃ¡ssico</h1>

  {% if resultado %}
  <p
    class="resultado-mensagem {% if 'Acertou' in resultado %}acertou{% elif 'Errou' in resultado %}errou{% elif 'nÃ£o encontrado' in resultado %}time-nao-encontrado{% endif %}"
  >
    {{ resultado }}
  </p>
  {% endif %} {% if jogo_finalizado %}
  <button class="botao-jogar-novamente" onclick="jogarNovamente()">
    ðŸŽ¯ Jogar Novamente
  </button>
  {% endif %}

  <!-- SeÃ§Ã£o de Dicas -->
  <div class="secao-dicas">
    <div class="contador-tentativas">
      <span class="label-contador">Tentativas Erradas:</span>
      <span class="numero-tentativas">{{ tentativas_erradas }}/7</span>
    </div>

    {% if mostrar_dica and time_secreto.mascote %}
    <div class="dica-container">
      <h3>ðŸ’¡ DICA LIBERADA!</h3>
      <p class="texto-dica">
        O mascote desse time Ã© o/a <strong>{{ time_secreto.mascote }}</strong>!
      </p>
    </div>
    {% elif tentativas_erradas >= 1 and tentativas_erradas < 7 %}
    <div class="dica-bloqueada">
      <p>ðŸ”’ Dica serÃ¡ liberada apÃ³s {{ 7 - tentativas_erradas }} erro(s)</p>
    </div>
    {% endif %}
  </div>

  <div class="formulario-chute">
    <form method="post" id="form-chute">
      <label for="chute">Digite um time:</label>
      <div class="autocomplete-container">
        <input
          type="text"
          id="chute"
          name="chute"
          required
          placeholder="Ex: Flamengo, Santos, Palmeiras..."
          autocomplete="off"
        />
        <div class="sugestoes-lista" id="sugestoes-lista"></div>
      </div>
      <button type="submit">Enviar</button>
    </form>
  </div>

  {% if tentativas %}
  <div class="tentativas-container">
    {% for time in tentativas %}
    <div class="tentativa-item">
      <div class="escudo-simples">
        <img
          src="{{ url_for('static', filename='times/' ~ time.nome_arquivo() ~ '.jpg') }}"
          alt="{{ time.nome }}"
        />
      </div>

      <div
        class="cores-simples"
        style="background-color: {% set resultado_cor = comparar_cores(time.cores, time_secreto.cores) %}{% if resultado_cor == 'exato' %}#28a745{% elif resultado_cor == 'parcial' %}#ffc107{% else %}#dc3545{% endif %}; color: {% if comparar_cores(time.cores, time_secreto.cores) == 'parcial' %}black{% else %}white{% endif %};"
      >
        <strong>{{ time.cores }}</strong>
      </div>

      <div
        class="estado-simples"
        style="background-color: {% if time.estado == time_secreto.estado %}#28a745{% else %}#dc3545{% endif %};"
      >
        <strong>{{ time.estado }}</strong>
      </div>

      <div
        class="ano-simples"
        style="background-color: {% if time.ano_fundacao == time_secreto.ano_fundacao %}#28a745{% else %}#dc3545{% endif %};"
      >
        <strong>{{ time.ano_fundacao }}</strong>
        {% set resultado_ano = comparar_anos(time.ano_fundacao,
        time_secreto.ano_fundacao) %} {% if resultado_ano == 'seta_cima'
        %}<span>â†‘</span>{% elif resultado_ano == 'seta_baixo' %}<span>â†“</span>{%
        endif %}
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <script>
    class FutdleGame {
      constructor() {
        this.sugestaoSelecionada = -1;
        this.sugestoes = [];
        this.timeoutId = null;
        this.init();
      }

      init() {
        this.setupAutoComplete();
        this.setupFormSubmit();
      }

      setupAutoComplete() {
        const input = document.getElementById("chute");
        const sugestoesLista = document.getElementById("sugestoes-lista");

        if (!input || !sugestoesLista) return;

        input.addEventListener("input", (e) => this.handleInput(e));
        input.addEventListener("keydown", (e) => this.handleKeydown(e));
        document.addEventListener("click", (e) => this.handleClickOutside(e));
      }

      handleInput(event) {
        const query = event.target.value.trim();
        clearTimeout(this.timeoutId);

        if (query.length < 1) {
          document.getElementById("sugestoes-lista").style.display = "none";
          return;
        }

        this.timeoutId = setTimeout(() => {
          fetch(`/api/sugestoes?q=${encodeURIComponent(query)}`)
            .then((response) => response.json())
            .then((data) => {
              this.sugestoes = data;
              this.sugestaoSelecionada = -1;
              this.mostrarSugestoes(data);
            })
            .catch((error) => {
              console.error("Erro ao buscar sugestÃµes:", error);
              document.getElementById("sugestoes-lista").style.display = "none";
            });
        }, 200);
      }

      handleKeydown(event) {
        const sugestoesLista = document.getElementById("sugestoes-lista");
        if (sugestoesLista.style.display === "none") return;

        switch (event.key) {
          case "ArrowDown":
            event.preventDefault();
            this.sugestaoSelecionada = Math.min(
              this.sugestaoSelecionada + 1,
              this.sugestoes.length - 1
            );
            this.atualizarSelecao();
            break;
          case "ArrowUp":
            event.preventDefault();
            this.sugestaoSelecionada = Math.max(
              this.sugestaoSelecionada - 1,
              -1
            );
            this.atualizarSelecao();
            break;
          case "Enter":
            if (this.sugestaoSelecionada >= 0) {
              event.preventDefault();
              this.selecionarSugestao(this.sugestoes[this.sugestaoSelecionada]);
            } else if (
              this.sugestoes.length > 0 &&
              sugestoesLista.style.display !== "none"
            ) {
              event.preventDefault();
              this.selecionarSugestao(this.sugestoes[0]);
            }
            break;
          case "Escape":
            sugestoesLista.style.display = "none";
            this.sugestaoSelecionada = -1;
            break;
        }
      }

      handleClickOutside(event) {
        if (!event.target.closest(".autocomplete-container")) {
          document.getElementById("sugestoes-lista").style.display = "none";
          this.sugestaoSelecionada = -1;
        }
      }

      mostrarSugestoes(sugestoes) {
        const sugestoesLista = document.getElementById("sugestoes-lista");

        if (sugestoes.length === 0) {
          sugestoesLista.style.display = "none";
          return;
        }

        sugestoesLista.innerHTML = sugestoes
          .map(
            (sugestao, index) =>
              `<div class="sugestao-item" data-index="${index}">
          <img src="/static/times/${sugestao.escudo}" alt="${sugestao.nome}" class="sugestao-escudo" onerror="this.style.display='none'">
          <span class="sugestao-nome">${sugestao.nome}</span>
        </div>`
          )
          .join("");

        sugestoesLista
          .querySelectorAll(".sugestao-item")
          .forEach((item, index) => {
            item.addEventListener("click", () =>
              this.selecionarSugestao(sugestoes[index])
            );
            item.addEventListener("mouseenter", () => {
              this.sugestaoSelecionada = index;
              this.atualizarSelecao();
            });
          });

        sugestoesLista.style.display = "block";
      }

      atualizarSelecao() {
        document.querySelectorAll(".sugestao-item").forEach((item, index) => {
          item.classList.toggle("selected", index === this.sugestaoSelecionada);
        });
      }

      selecionarSugestao(sugestao) {
        const input = document.getElementById("chute");
        input.value = sugestao.nome;
        document.getElementById("sugestoes-lista").style.display = "none";
        this.sugestaoSelecionada = -1;
        document
          .getElementById("form-chute")
          .dispatchEvent(new Event("submit"));
      }

      setupFormSubmit() {
        const form = document.getElementById("form-chute");
        if (!form) return;

        form.addEventListener("submit", (event) => {
          event.preventDefault();

          fetch(window.location.href, {
            method: "POST",
            body: new FormData(form),
          })
            .then((response) => response.text())
            .then((html) => {
              const tempDiv = document.createElement("div");
              tempDiv.innerHTML = html;
              const novoConteudo = tempDiv.querySelector(".conteudo-classico");

              if (novoConteudo) {
                document.querySelector(".conteudo-classico").innerHTML =
                  novoConteudo.innerHTML;
                const input = document.getElementById("chute");
                if (input) {
                  input.value = "";
                  input.focus();
                }
                // Reinicializar a funcionalidade
                new FutdleGame();
              }
            })
            .catch((error) => {
              console.error("Erro:", error);
              form.submit();
            });
        });
      }
    }

    // FunÃ§Ã£o global para o botÃ£o "Jogar Novamente"
    function jogarNovamente() {
      fetch("/reiniciar-jogo", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.success) window.location.reload();
        })
        .catch((error) => {
          console.error("Erro ao reiniciar jogo:", error);
          window.location.reload();
        });
    }

    // Inicializar o jogo
    document.addEventListener("DOMContentLoaded", () => new FutdleGame());
  </script>
</div>

{% endblock %}
